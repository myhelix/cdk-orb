description: >
  Runs terraform plan, and posts the output as a comment on the pull request.

executor:
  name: default
  tag: << parameters.node_version >>

parameters:
  node_version:
    description: Node.js version to use
    type: string
    default: "16.14"
  workspace_dir:
    description: Directory to attach workspace
    type: string
    default: "."
  terraform_dir:
    description: Directory containing Terraform files
    type: string
    default: "."
  plan_file_path:
    description: Path to save terraform plan output
    type: string
    default: "/tmp/plan.txt"
  aws_role_arn:
    description: ARN of the AWS IAM role to assume via OIDC
    type: string
    default: ""
  use_aws_secret:
    description: Whether to use AWS Secrets Manager for GitHub token
    type: boolean
    default: true
  aws_region:
    description: AWS region to use for role assumption and secrets
    type: string
    default: "us-east-1"

steps:
  - checkout
  - attach_workspace:
      at: << parameters.workspace_dir >>
  - when:
      condition: << parameters.use_aws_secret >>
      steps:
        - assume_oidc_role:
            aws_role_arn: << parameters.aws_role_arn >>
            aws_region: << parameters.aws_region >>
  - terraform/install:
      terraform_version: "1.12.0"
  - run:
      name: Run terraform plan and save output
      command: |
        cd << parameters.terraform_dir >>
        terraform init
        terraform plan -no-color > << parameters.plan_file_path >>
  - terraform-plan-to-comment:
      plan_file_path: << parameters.plan_file_path >>
      use_aws_secret: << parameters.use_aws_secret >>
